name: Update Changelog

on:
  push:
    branches:
      - main

permissions:
  contents: write

concurrency:
  group: update-docs-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Vérifie si on doit skip ce workflow
  check-skip:
    runs-on: ubuntu-latest
    if: ${{ github.repository == 'Elohyrr/altiez' }}
    outputs:
      should_skip: ${{ steps.check.outputs.skip }}
    steps:
      - name: Check commit title
        id: check
        run: |
          # Extrait seulement la première ligne (titre) du message
          TITLE=$(echo "${{ github.event.head_commit.message }}" | head -1)
          echo "Commit title: $TITLE"
          
          # Vérifie si le TITRE contient [skip ci]
          if echo "$TITLE" | grep -q "\[skip ci\]"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "⏭️ Skipping: [skip ci] found in commit title"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "✅ Proceeding: no [skip ci] in commit title"
          fi
  
  # Vérifie d'abord que le commit est bien formaté
  validate-commit:
    runs-on: ubuntu-latest
    needs: check-skip
    if: ${{ github.repository == 'Elohyrr/altiez' && needs.check-skip.outputs.should_skip == 'false' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install commitlint
        run: |
          npm install -g @commitlint/cli @commitlint/config-conventional
          
      - name: Create commitlint config
        run: |
          echo "module.exports = {extends: ['@commitlint/config-conventional']}" > commitlint.config.js
          
      - name: Validate last commit
        run: |
          echo "=== Validating commit message ==="
          # Valide seulement la première ligne (titre) du commit
          echo "${{ github.event.head_commit.message }}" | head -1 | npx commitlint

  # Génère le changelog seulement si le commit est valide
  changelog:
    runs-on: ubuntu-latest
    needs: [check-skip, validate-commit]
    # S'exécute même si validate-commit est skippé, mais seulement si should_skip est false ET dans le repo principal
    if: ${{ github.repository == 'Elohyrr/altiez' && always() && needs.check-skip.outputs.should_skip == 'false' && (needs.validate-commit.result == 'success' || needs.validate-commit.result == 'skipped') }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Install git-cliff
        run: |
          wget https://github.com/orhun/git-cliff/releases/download/v2.4.0/git-cliff-2.4.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf git-cliff-2.4.0-x86_64-unknown-linux-gnu.tar.gz
          sudo mv git-cliff-2.4.0/git-cliff /usr/local/bin/
          git-cliff --version
          
      - name: Generate changelog
        run: |
          git-cliff --config cliff.toml --output docs/CHANGELOG.md
          
      - name: Commit changelog
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git add docs/CHANGELOG.md
          if ! git diff --quiet || ! git diff --staged --quiet; then
            git commit -m "docs: update changelog [skip ci]"
            # Pull avec rebase au cas où un autre workflow a push entre temps
            git pull --rebase origin main
            git push
          fi